database : springdb
username : springuser
pw : mysql

-- 1. 데이터베이스 생성 (이름: springdb)
CREATE DATABASE IF NOT EXISTS springdb DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- 2. 사용자 생성 (아이디: springuser, 비밀번호: mysql)
-- 'localhost'는 DB와 웹 서버가 같은 컴퓨터에 있을 때 사용합니다.
CREATE USER IF NOT EXISTS 'springuser'@'localhost' IDENTIFIED BY 'mysql';

GRANT ALL PRIVILEGES ON springdb.* TO 'springuser'@'localhost';

FLUSH PRIVILEGES;

CREATE TABLE IF NOT EXISTS board (
    bno INT NOT NULL AUTO_INCREMENT COMMENT '게시글 번호(PK)',
    title VARCHAR(200) NOT NULL COMMENT '제목',
    content TEXT COMMENT '내용',
    writer VARCHAR(50) NOT NULL COMMENT '작성자',
    read_count INT DEFAULT 0 COMMENT '조회수',
    is_del CHAR(1) DEFAULT 'N' COMMENT '삭제여부(Y/N)',
    reg_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '작성일',
    PRIMARY KEY (bno)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;


-- 회원 테이블 생성
CREATE TABLE IF NOT EXISTS member (
    id VARCHAR(50) NOT NULL COMMENT '아이디',
    pw VARCHAR(100) NOT NULL COMMENT '비밀번호',
    name VARCHAR(50) NOT NULL COMMENT '이름',
    reg_date DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '가입일',
    PRIMARY KEY (id)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- 테스트용 계정 추가 (아이디: admin / 비번: 1234)
INSERT INTO member (id, pw, name) VALUES ('admin', '1234', '관리자');

CREATE TABLE IF NOT EXISTS reply (
    rno INT AUTO_INCREMENT PRIMARY KEY,
    bno INT NOT NULL,
    reply VARCHAR(1000) NOT NULL,
    replyer VARCHAR(50) NOT NULL,
    replyDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    updateDate DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (bno) REFERENCES board(bno) ON DELETE CASCADE
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- 조회수 중복 방지 로그 테이블
CREATE TABLE IF NOT EXISTS board_read_log (
    log_no INT AUTO_INCREMENT PRIMARY KEY,
    bno INT NOT NULL,
    reader_id VARCHAR(50) NOT NULL,
    read_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (bno) REFERENCES board(bno) ON DELETE CASCADE,
    UNIQUE KEY unique_read (bno, reader_id)  -- 중요: (글번호, 아이디) 조합은 유일해야 함
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

DELIMITER $$
CREATE PROCEDURE insertLoop()
BEGIN
    DECLARE i INT DEFAULT 1;
    WHILE i <= 100 DO
        INSERT INTO board(title, content, writer)
        VALUES (concat('테스트 제목 ', i), concat('테스트 내용 ', i), concat('user', i % 10));
        SET i = i + 1;
    END WHILE;
END$$
DELIMITER ;

CALL insertLoop();
DROP PROCEDURE insertLoop;

-- 파일 테이블 생성
CREATE TABLE file (
    uuid VARCHAR(100) PRIMARY KEY,       -- 고유 식별자
    upload_path VARCHAR(200) NOT NULL,   -- 저장 경로
    file_name VARCHAR(100) NOT NULL,     -- 원본 파일명
    file_type BOOLEAN DEFAULT 0,         -- 이미지 여부
    bno INT,                             -- [수정됨] board 테이블과 동일하게 INT로 변경
    file_size BIGINT,                    -- 파일 크기
    reg_date DATETIME DEFAULT NOW(),     -- 등록일
    CONSTRAINT fk_file_board FOREIGN KEY (bno) 
    REFERENCES board (bno) ON DELETE CASCADE
);

-- 기존에 file 테이블을 만들다가 실패한 찌꺼기가 있다면 삭제
DROP TABLE IF EXISTS file;
DROP TABLE IF EXISTS tbl_file;

-- 테이블 생성 (이름: tbl_file)
CREATE TABLE tbl_file (
    uuid VARCHAR(100) PRIMARY KEY,       -- 파일 고유 ID
    upload_path VARCHAR(200) NOT NULL,   -- 저장 폴더명 (image, video, others)
    file_name VARCHAR(100) NOT NULL,     -- 원본 파일명
    file_type BOOLEAN DEFAULT 0,         -- 이미지 여부 (1:이미지, 0:그외)
    bno INT,                             -- 게시글 번호 (board 테이블 bno와 타입 일치: INT)
    file_size BIGINT,                    -- 파일 크기
    reg_date DATETIME DEFAULT NOW(),     -- 등록일
    CONSTRAINT fk_file_board FOREIGN KEY (bno) 
    REFERENCES board (bno) ON DELETE CASCADE
);

-- 1. 기존 테이블이 있다면 삭제 (외래키 제약조건 때문에 자식 테이블인 auth부터 삭제)
DROP TABLE IF EXISTS auth;
DROP TABLE IF EXISTS member;

-- 2. 회원 테이블 (member) 생성
-- 컬럼: email(PK), pwd, nick_name, reg_date, last_login
CREATE TABLE member (
    email VARCHAR(100) NOT NULL,        -- 이메일 (Primary Key)
    pwd VARCHAR(100) NOT NULL,          -- 비밀번호 (암호화 저장 예정)
    nick_name VARCHAR(50) NOT NULL,     -- 닉네임
    reg_date DATETIME DEFAULT NOW(),    -- 가입일
    last_login DATETIME DEFAULT NULL,   -- 마지막 로그인 시간
    PRIMARY KEY (email)
);

-- 3. 권한 테이블 (auth) 생성
-- 컬럼: id(PK), email(FK), auth
CREATE TABLE auth (
    id INT AUTO_INCREMENT,              -- 고유 번호 (PK)
    email VARCHAR(100) NOT NULL,        -- 회원 이메일 (FK)
    auth VARCHAR(50) NOT NULL,          -- 권한 (ROLE_USER, ROLE_ADMIN 등)
    PRIMARY KEY (id),
    CONSTRAINT fk_auth_member FOREIGN KEY (email) REFERENCES member(email) ON DELETE CASCADE
);

-- 4. 테스트 데이터 넣기 (선택사항)
-- 관리자 계정 하나 생성 (비밀번호 '1111' -> 암호화 안 된 상태이므로 나중에 문제될 수 있음, 일단 테스트용)
INSERT INTO member (email, pwd, nick_name) VALUES ('admin@test.com', '1111', '관리자');
INSERT INTO auth (email, auth) VALUES ('admin@test.com', 'ROLE_USER');
INSERT INTO auth (email, auth) VALUES ('admin@test.com', 'ROLE_ADMIN');







